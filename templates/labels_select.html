{% extends "base.html" %}
{# Hide footer on labels page #}
{% block footer %}{% endblock %}

{% block content %}

<section class="panel">
    <h2>Print Labels</h2>

    <form method="post" action="/print/labels" class="labels-select" id="label-form">

        <fieldset>
            <legend>Containers</legend>

            {% for c in containers %}
            <div class="label-row">
                <label class="checkbox">
                    <input type="checkbox" name="code" value="{{ c }}">
                    <span class="mono">{{ c }}</span>
                </label>

                <input type="text" name="text_{{ c }}" placeholder="Optional label text (e.g. R 1kâ€“10k E24 1%)"
                    class="labeltext" />
            </div>
            {% endfor %}
        </fieldset>

        <fieldset class="label-format">
            <legend>Label format</legend>

            <select name="preset" required>
                {% for p in presets %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>

            <select name="mode" required>
                {% for v, label in modes %}
                <option value="{{ v }}">{{ label }}</option>
                {% endfor %}
            </select>

            <label class="checkbox outline-toggle">
                <input type="checkbox" name="outline" value="1" id="outline">
                <span>Print cut outlines</span>
                <span class="muted">(always shown on screen; printed only when enabled)</span>
            </label>
        </fieldset>

        <div class="actions">
            <button class="btn" type="submit" id="print-btn" disabled>Print selected</button>
        </div>

    </form>
</section>

<script>
    (() => {
        const form = document.getElementById("label-form");
        const btn = document.getElementById("print-btn");
        const preset = form?.querySelector('select[name="preset"]');
        const mode = form?.querySelector('select[name="mode"]');
        const outline = form?.querySelector('input[name="outline"]');
        if (!form || !btn) return;

        const KEY = "labels.print.settings";

        const loadSettings = () => {
            try {
                const raw = localStorage.getItem(KEY);
                if (!raw) return;
                const s = JSON.parse(raw);
                if (preset && typeof s?.preset === "string") preset.value = s.preset;
                if (mode && typeof s?.mode === "string") mode.value = s.mode;
                if (outline && typeof s?.outline === "boolean") outline.checked = s.outline;
            } catch {
                // ignore
            }
        };

        const saveSettings = () => {
            try {
                localStorage.setItem(
                    KEY,
                    JSON.stringify({
                        preset: preset?.value || "",
                        mode: mode?.value || "",
                        outline: !!outline?.checked,
                    })
                );
            } catch {
                // ignore
            }
        };

        const update = () => {
            btn.disabled = form.querySelectorAll('input[name="code"]:checked').length === 0;
        };

        form.addEventListener("change", (e) => {
            if (e.target && e.target.matches('input[name="code"]')) update();
            if (e.target && (e.target === preset || e.target === mode || e.target === outline)) saveSettings();
        });

        loadSettings();

        update();
    })();
</script>


{% endblock %}